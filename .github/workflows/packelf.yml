name: Pack ELF

on:
  workflow_dispatch:
    inputs:
      binary_url:
        description: "Direct link to the binary file (may be compressed)"
        required: true
      binary_name:
        description: "Name of the binary file inside archive (or standalone binary name)"
        required: true
      output_name:
        description: "Name of the packed output file (without extension)"
        required: true

permissions:
  contents: write

jobs:
  pack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make packelf.sh executable
        run: chmod +x packelf.sh

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar unzip xz-utils bzip2

      - name: Download binary (or archive)
        run: |
          wget -O input_file "${{ github.event.inputs.binary_url }}"

      - name: Extract if compressed
        run: |
          mkdir extracted
          file_type=$(file -b input_file)
          if echo "$file_type" | grep -qi "gzip compressed"; then
            tar -xzf input_file -C extracted || true
          elif echo "$file_type" | grep -qi "bzip2 compressed"; then
            tar -xjf input_file -C extracted || true
          elif echo "$file_type" | grep -qi "xz compressed"; then
            tar -xJf input_file -C extracted || true
          elif echo "$file_type" | grep -qi "Zip archive"; then
            unzip -d extracted input_file || true
          else
            # If not compressed, copy it directly
            cp input_file "extracted/${{ github.event.inputs.binary_name }}"
          fi

      - name: Verify extracted binary
        run: |
          ls -lah extracted
          if [ ! -f "extracted/${{ github.event.inputs.binary_name }}" ]; then
            echo "‚ùå Binary ${{ github.event.inputs.binary_name }} not found after extraction"
            exit 1
          fi
          chmod +x "extracted/${{ github.event.inputs.binary_name }}"

      - name: Pack ELF
        run: |
          ./packelf.sh "extracted/${{ github.event.inputs.binary_name }}" "${{ github.event.inputs.output_name }}"

      - name: Archive packed binary
        run: |
          tar -czf "${{ github.event.inputs.output_name }}.tar.gz" "${{ github.event.inputs.output_name }}"

      - name: Create GitHub Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          tag_name: packed-latest
          name: "Packed Binary Release"
          body: "Packed binary generated from ${{ github.event.inputs.binary_url }}"
          files: ${{ github.event.inputs.output_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
