name: Pack ELF

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "Select mode of operation"
        required: true
        default: "pack"
        type: choice
        options:
          - explore
          - pack
      binary_url:
        description: "Direct link to the binary file (may be compressed or plain ELF)"
        required: true
      binary_name:
        description: "Name of the binary file inside archive (used only in 'pack' mode, ignored if URL is plain ELF)"
        required: false
      output_name:
        description: "Name of the packed output file (without extension, used only in 'pack' mode)"
        required: false

permissions:
  contents: write

jobs:
  pack:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Make packelf.sh executable
        run: chmod +x packelf.sh

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar unzip xz-utils bzip2 gh file

      - name: Download binary (or archive)
        run: |
          wget -O input_file "${{ github.event.inputs.binary_url }}"

      - name: Extract or copy file
        run: |
          mkdir extracted
          file_type=$(file -b input_file || true)

          if echo "$file_type" | grep -qi "gzip compressed"; then
            tar -xzf input_file -C extracted || true
          elif echo "$file_type" | grep -qi "bzip2 compressed"; then
            tar -xjf input_file -C extracted || true
          elif echo "$file_type" | grep -qi "xz compressed"; then
            tar -xJf input_file -C extracted || true
          elif echo "$file_type" | grep -qi "Zip archive"; then
            unzip -d extracted input_file || true
          else
            echo "➡️ Detected plain binary file, copying to extracted/"
            cp input_file "extracted/"
          fi

      - name: List extracted binaries
        if: ${{ github.event.inputs.mode == 'explore' }}
        run: |
          echo "🔎 Searching for executable files..."
          find extracted -type f -executable || true

      - name: Verify extracted binary
        if: ${{ github.event.inputs.mode == 'pack' }}
        run: |
          if [ -n "${{ github.event.inputs.binary_name }}" ]; then
            binary_path=$(find extracted -type f -name "${{ github.event.inputs.binary_name }}" | head -n 1)
          else
            # If binary_name not provided, assume the only file in extracted is the binary
            binary_path=$(find extracted -type f -executable | head -n 1)
          fi

          if [ -z "$binary_path" ]; then
            echo "❌ Binary not found after extraction"
            exit 1
          fi

          echo "✅ Using binary: $binary_path"
          chmod +x "$binary_path"
          echo "BINARY_PATH=$binary_path" >> $GITHUB_ENV

      - name: Pack ELF
        if: ${{ github.event.inputs.mode == 'pack' }}
        run: |
          ./packelf.sh "$BINARY_PATH" "${{ github.event.inputs.output_name }}"

      - name: Archive packed binary
        if: ${{ github.event.inputs.mode == 'pack' }}
        run: |
          tar -czf "${{ github.event.inputs.output_name }}.tar.gz" "${{ github.event.inputs.output_name }}"

      - name: Delete old release assets
        if: ${{ github.event.inputs.mode == 'pack' }}
        run: |
          gh release view packed-latest --json assets -q '.assets[].name' | while read asset; do
            gh release delete-asset packed-latest "$asset" -y || true
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or Update GitHub Release and Upload
        if: ${{ github.event.inputs.mode == 'pack' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: packed-latest
          name: "Packed Binary Release"
          body: "Packed binary generated from ${{ github.event.inputs.binary_url }}"
          files: ${{ github.event.inputs.output_name }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
